# OpenBMC for HPE Proliant Servers
This layer provides support for HPE Proliant Gen12 Servers.

## Preparing for OpenBMC on HPE Proliant Gen12 Servers
HPE Proliant Gen12 Servers use a custom BMC ASIC that are protected with a Silicon Root of Trust (SRoT) which ensures that only validated firmware can boot. Customers wishing to run custom firmware, like OpenBMC, should [reach out to HPE](https://www.hpe.com/us/en/compute/openbmc-proliant-servers.html) to learn more about how to add their own public key to the SRoT.

After adding a customer key to the SRoT a custom firmware can be loaded. When running custom firmware, like OpenBMC, the SRoT's firmware validation ends once U-Boot begins executing. Once U-Boot loads customers can optionally use U-Boot functionality for further payload validation.

In the event that U-Boot fails to validate the SRoT will trigger a recovery, reverting the system to iLO, but maintaining the applied customer public key.

## Building OpenBMC for HPE Proliant Gen12 Servers
The private key generated by the preparation stage is used in every OpenBMC build that includes this layer to automatically generate a U-Boot Signature and place the signature into the MTD & update files. This is all controlled with the `UBOOT_SIGNING_KEY` environment variable, allowing both individual developers & CI/CD systems to easily inject the private key into the build as a secret outside of the git repository. The recommended way to configure this is in `~/.bashrc`:
```bash
export UBOOT_SIGNING_KEY="/path/to/customer_private_key.pem"
export BB_ENV_PASSTHROUGH_ADDITIONS="UBOOT_SIGNING_KEY ${BB_ENV_PASSTHROUGH_ADDITIONS}"
```
Don't forget to `. ~/.bashrc` or logout & log back in to the build system if the `~/.bashrc` file is updated!

Once the `UBOOT_SIGNING_KEY` variable is configured the build proceeds in the same way as a standard OpenBMC build:
```bash
. setup gsc
bitbake obmc-phosphor-image
```

## Initial Flashing From iLO to OpenBMC
Please see the instructions provided as part of the customer kit in the preparation stage for additional scripts to wrap the OpenBMC MTD file in an iLO format. This is a one-time requirement whenever first installing OpenBMC on top of iLO.

## Subsequent Updates From OpenBMC to OpenBMC
Once the HPE Proliant Gen12 Server is running OpenBMC the standard OpenBMC update methods are used.

## Reverting From OpenBMC to iLO
In the event that a customer wishes to revert to iLO the recommend method is to corrupt the U-Boot Signature and reboot, allowing the SRoT's built-in recovery functionality to restore iLO. Please note that restoring iLO in this way may revert to an older, unsupported version of iLO that requires one or more immediate iLO updates.
